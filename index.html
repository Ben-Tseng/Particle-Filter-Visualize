<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Particle Filter — Step-by-Step Breakdown</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'Segoe UI', sans-serif;
    background: #0f1117;
    color: #e2e8f0;
    min-height: 100vh;
    padding: 32px 20px;
  }

  h1 {
    text-align: center;
    font-size: 1.6rem;
    color: #fff;
    margin-bottom: 6px;
    letter-spacing: 0.5px;
  }
  .subtitle {
    text-align: center;
    color: #64748b;
    font-size: 0.85rem;
    margin-bottom: 28px;
  }

  /* Step tabs */
  .tabs {
    display: flex;
    justify-content: center;
    gap: 8px;
    flex-wrap: wrap;
    margin-bottom: 28px;
  }
  .tab {
    background: #1e2130;
    border: 1px solid #2e3348;
    color: #94a3b8;
    padding: 8px 18px;
    border-radius: 20px;
    cursor: pointer;
    font-size: 0.82rem;
    transition: all 0.25s;
    user-select: none;
  }
  .tab:hover { border-color: #5b6abf; color: #cbd5e1; }
  .tab.active {
    background: #3b4cc0;
    border-color: #3b4cc0;
    color: #fff;
    font-weight: 600;
  }

  /* Main card */
  .card {
    max-width: 780px;
    margin: 0 auto;
    background: #1a1d2e;
    border: 1px solid #2e3348;
    border-radius: 16px;
    overflow: hidden;
  }

  .card-header {
    padding: 18px 24px 14px;
    border-bottom: 1px solid #2e3348;
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .step-badge {
    background: #3b4cc0;
    color: #fff;
    font-weight: 700;
    font-size: 0.75rem;
    padding: 4px 10px;
    border-radius: 12px;
    white-space: nowrap;
  }
  .card-header h2 {
    font-size: 1.1rem;
    color: #fff;
  }
  .card-header .q-tag {
    margin-left: auto;
    background: #2a2d42;
    color: #7c85b8;
    font-size: 0.72rem;
    padding: 3px 9px;
    border-radius: 8px;
  }

  .card-body { padding: 22px 24px; }

  /* Description */
  .desc {
    color: #94a3b8;
    font-size: 0.88rem;
    line-height: 1.6;
    margin-bottom: 20px;
  }
  .desc strong { color: #c9d1f5; }

  /* SVG diagram area */
  .diagram {
    background: #131522;
    border-radius: 12px;
    padding: 18px;
    margin-bottom: 20px;
    display: flex;
    justify-content: center;
  }
  .diagram svg { max-width: 100%; height: auto; }

  /* Code snippet */
  .code-block {
    background: #111420;
    border: 1px solid #2a2e42;
    border-radius: 10px;
    padding: 14px 18px;
    margin-bottom: 18px;
    overflow-x: auto;
  }
  .code-block .label {
    font-size: 0.68rem;
    color: #5a6282;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 8px;
  }
  pre { font-size: 0.78rem; line-height: 1.7; color: #c4cce0; font-family: 'Fira Code', monospace; }
  .kw { color: #7c8aff; }
  .fn { color: #50c878; }
  .cm { color: #4a5568; font-style: italic; }
  .st { color: #f0ad4e; }
  .vr { color: #e2e8f0; }

  /* Key points */
  .keys { display: flex; flex-direction: column; gap: 8px; }
  .key-item {
    display: flex; align-items: flex-start; gap: 10px;
    background: #161923; border: 1px solid #252a3a; border-radius: 8px;
    padding: 10px 14px;
  }
  .key-icon {
    width: 22px; height: 22px; border-radius: 6px;
    display: flex; align-items: center; justify-content: center;
    font-size: 0.7rem; flex-shrink: 0; font-weight: 700;
  }
  .key-icon.green { background: #1a3a2a; color: #50c878; }
  .key-icon.blue  { background: #1a2240; color: #7c8aff; }
  .key-icon.orange{ background: #3a2a1a; color: #f0ad4e; }
  .key-text { font-size: 0.82rem; color: #94a3b8; line-height: 1.5; }
  .key-text strong { color: #c9d1f5; }

  /* Nav buttons */
  .nav {
    display: flex;
    justify-content: center;
    gap: 12px;
    margin-top: 24px;
  }
  .nav-btn {
    background: #1e2130; border: 1px solid #2e3348; color: #94a3b8;
    padding: 8px 22px; border-radius: 20px; cursor: pointer;
    font-size: 0.82rem; transition: all 0.2s;
  }
  .nav-btn:hover { border-color: #3b4cc0; color: #fff; }
  .nav-btn:disabled { opacity: 0.3; cursor: default; }

  /* Overview specific */
  .overview-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-bottom: 20px;
  }
  .ov-card {
    background: #131522;
    border: 1px solid #2e3348;
    border-radius: 10px;
    padding: 14px;
    text-align: center;
  }
  .ov-card .num { font-size: 1.6rem; font-weight: 700; color: #7c8aff; }
  .ov-card .lbl { font-size: 0.72rem; color: #64748b; margin-top: 2px; }
  .ov-card .ov-desc { font-size: 0.76rem; color: #6b7280; margin-top: 6px; line-height: 1.4; }

  .arrow-row {
    display: flex; align-items: center; justify-content: center; gap: 6px;
    margin: 14px 0;
  }
  .arrow-box {
    background: #1e2130; border: 1px solid #2e3348; border-radius: 8px;
    padding: 6px 14px; font-size: 0.78rem; color: #94a3b8;
  }
  .arrow-sym { color: #3b4cc0; font-size: 1.2rem; }

  .hidden { display: none; }
</style>
</head>
<body>

<h1>Particle Filter — Step-by-Step Breakdown</h1>
<p class="subtitle">How do Q4 → Q5 → Q6 build up a localization system?</p>

<div class="tabs" id="tabs"></div>

<!-- ========== STEP 0: Overview ========== -->
<div class="card" id="step-0">
  <div class="card-header">
    <span class="step-badge">Overview</span>
    <h2>What are these questions about?</h2>
  </div>
  <div class="card-body">
    <p class="desc">
      A robot is placed in an unknown environment — it <strong>doesn't know where it is</strong>. A particle filter solves this by using a large number of particles as guesses for the robot's position, then narrowing them down using sensor data.
    </p>
    <div class="overview-grid">
      <div class="ov-card">
        <div class="num" style="color:#50c878">Q4</div>
        <div class="lbl">Motion Model</div>
        <div class="ov-desc">How does the robot <strong>move</strong>?</div>
      </div>
      <div class="ov-card">
        <div class="num" style="color:#7c8aff">Q5</div>
        <div class="lbl">Sensing Model</div>
        <div class="ov-desc">How does the robot <strong>sense</strong>?</div>
      </div>
      <div class="ov-card" style="grid-column:span 2; background:#1a1d2e; border-color:#3b4cc0;">
        <div class="num" style="color:#f0ad4e">Q6</div>
        <div class="lbl">Full Particle Filter</div>
        <div class="ov-desc">Q4 + Q5 combined → achieve <strong>localization</strong></div>
      </div>
    </div>
    <div class="arrow-row">
      <div class="arrow-box">Init: random particles</div>
      <span class="arrow-sym">→</span>
      <div class="arrow-box">Predict (move)</div>
      <span class="arrow-sym">→</span>
      <div class="arrow-box">Update (sense)</div>
      <span class="arrow-sym">→</span>
      <div class="arrow-box">Resample</div>
      <span class="arrow-sym">→</span>
      <div class="arrow-box">Repeat…</div>
    </div>
    <div class="keys">
      <div class="key-item">
        <div class="key-icon green">✓</div>
        <div class="key-text">The core idea: use <strong>many guesses (particles)</strong> to represent positional uncertainty, then converge to the true position through repeated cycles of move → sense → filter.</div>
      </div>
    </div>
  </div>
</div>

<!-- ========== STEP 1: Initial State ========== -->
<div class="card hidden" id="step-1">
  <div class="card-header">
    <span class="step-badge">Step 1</span>
    <h2>Initialization: Particles scattered randomly</h2>
  </div>
  <div class="card-body">
    <p class="desc">
      At the start we <strong>don't know where the robot is</strong>, so we generate N particles at random positions across the map. Each particle is one "guess" for the robot's location and heading.
    </p>
    <div class="diagram">
      <svg width="520" height="260" viewBox="0 0 520 260">
        <rect x="30" y="20" width="460" height="220" rx="8" fill="#1a1d2e" stroke="#2e3348" stroke-width="1.5"/>
        <text x="50" y="42" font-size="11" fill="#4a5568">Map (100 x 100)</text>

        <circle cx="60" cy="55" r="5" fill="#f0ad4e"/><text x="68" y="59" font-size="9" fill="#f0ad4e">Landmark 1</text>
        <circle cx="460" cy="55" r="5" fill="#f0ad4e"/><text x="418" y="59" font-size="9" fill="#f0ad4e">Landmark 2</text>
        <circle cx="60" cy="215" r="5" fill="#f0ad4e"/><text x="68" y="219" font-size="9" fill="#f0ad4e">Landmark 3</text>
        <circle cx="460" cy="215" r="5" fill="#f0ad4e"/><text x="418" y="219" font-size="9" fill="#f0ad4e">Landmark 4</text>

        <circle cx="300" cy="150" r="14" fill="none" stroke="#3b4cc0" stroke-width="2" stroke-dasharray="4,3"/>
        <text x="294" y="155" font-size="14" fill="#3b4cc0" font-weight="700">?</text>

        <g opacity="0.7">
          <circle cx="100" cy="80" r="4" fill="#7c8aff"/><line x1="100" y1="80" x2="112" y2="74" stroke="#7c8aff" stroke-width="1.5"/>
          <circle cx="200" cy="120" r="4" fill="#7c8aff"/><line x1="200" y1="120" x2="195" y2="108" stroke="#7c8aff" stroke-width="1.5"/>
          <circle cx="350" cy="90" r="4" fill="#7c8aff"/><line x1="350" y1="90" x2="362" y2="88" stroke="#7c8aff" stroke-width="1.5"/>
          <circle cx="150" cy="190" r="4" fill="#7c8aff"/><line x1="150" y1="190" x2="145" y2="178" stroke="#7c8aff" stroke-width="1.5"/>
          <circle cx="400" cy="170" r="4" fill="#7c8aff"/><line x1="400" y1="170" x2="410" y2="160" stroke="#7c8aff" stroke-width="1.5"/>
          <circle cx="80" cy="150" r="4" fill="#7c8aff"/><line x1="80" y1="150" x2="70" y2="142" stroke="#7c8aff" stroke-width="1.5"/>
          <circle cx="260" cy="200" r="4" fill="#7c8aff"/><line x1="260" y1="200" x2="272" y2="205" stroke="#7c8aff" stroke-width="1.5"/>
          <circle cx="420" cy="100" r="4" fill="#7c8aff"/><line x1="420" y1="100" x2="415" y2="88" stroke="#7c8aff" stroke-width="1.5"/>
          <circle cx="180" cy="60" r="4" fill="#7c8aff"/><line x1="180" y1="60" x2="190" y2="55" stroke="#7c8aff" stroke-width="1.5"/>
          <circle cx="320" cy="180" r="4" fill="#7c8aff"/><line x1="320" y1="180" x2="325" y2="168" stroke="#7c8aff" stroke-width="1.5"/>
        </g>

        <circle cx="50" cy="245" r="4" fill="#7c8aff"/><text x="58" y="249" font-size="9" fill="#7c8aff">Particle (guessed position)</text>
        <circle cx="230" cy="245" r="5" fill="none" stroke="#3b4cc0" stroke-width="1.5" stroke-dasharray="3,2"/><text x="240" y="249" font-size="9" fill="#3b4cc0">True position (unknown)</text>
        <circle cx="400" cy="245" r="4" fill="#f0ad4e"/><text x="408" y="249" font-size="9" fill="#f0ad4e">Landmark</text>
      </svg>
    </div>
    <div class="code-block">
      <div class="label">Pseudocode — Initialize particles</div>
      <pre><span class="kw">FOR</span> each particle <span class="vr">i</span> <span class="kw">IN</span> 1 .. N:
    <span class="vr">particle[i]</span> ← <span class="fn">create robot</span> at <span class="st">random position & heading</span>
    <span class="fn">set noise</span>(<span class="vr">particle[i]</span>)
    <span class="fn">add</span> <span class="vr">particle[i]</span> <span class="kw">TO</span> particle list          <span class="cm">// N guesses, all random</span></pre>
    </div>
    <div class="keys">
      <div class="key-item">
        <div class="key-icon blue">!</div>
        <div class="key-text">Each particle carries <strong>x, y, and orientation</strong>. At this stage they are completely random — no useful information yet.</div>
      </div>
    </div>
  </div>
</div>

<!-- ========== STEP 2: Predict (Move) ========== -->
<div class="card hidden" id="step-2">
  <div class="card-header">
    <span class="step-badge">Step 2</span>
    <h2>Predict: Every particle executes move()</h2>
    <span class="q-tag">← Q4</span>
  </div>
  <div class="card-body">
    <p class="desc">
      The robot has moved, so every particle must move too. Each particle updates its position based on the motion command <strong>(steering, distance)</strong>. Because of noise, each particle ends up at a slightly different location.
    </p>
    <div class="diagram">
      <svg width="520" height="260" viewBox="0 0 520 260">
        <defs>
          <marker id="arrowBlue" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
            <polygon points="0 0, 8 3, 0 6" fill="#7c8aff"/>
          </marker>
          <marker id="arrowGreen" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
            <polygon points="0 0, 8 3, 0 6" fill="#50c878"/>
          </marker>
        </defs>

        <rect x="10" y="20" width="230" height="220" rx="8" fill="#1a1d2e" stroke="#2e3348" stroke-width="1"/>
        <text x="25" y="42" font-size="10" fill="#4a5568">Before move</text>
        <circle cx="80" cy="100" r="5" fill="#7c8aff" opacity="0.5"/>
        <circle cx="140" cy="140" r="5" fill="#7c8aff" opacity="0.5"/>
        <circle cx="100" cy="180" r="5" fill="#7c8aff" opacity="0.5"/>
        <circle cx="180" cy="110" r="5" fill="#7c8aff" opacity="0.5"/>
        <circle cx="60" cy="160" r="5" fill="#7c8aff" opacity="0.5"/>

        <text x="255" y="130" font-size="22" fill="#3b4cc0" text-anchor="middle">→</text>
        <text x="255" y="148" font-size="9" fill="#4a5568" text-anchor="middle">move()</text>
        <text x="255" y="160" font-size="8" fill="#4a5568" text-anchor="middle">+ noise</text>

        <rect x="280" y="20" width="230" height="220" rx="8" fill="#1a1d2e" stroke="#2e3348" stroke-width="1"/>
        <text x="295" y="42" font-size="10" fill="#4a5568">After move</text>

        <line x1="80" y1="100" x2="118" y2="78" stroke="#7c8aff" stroke-width="1" stroke-dasharray="3,2" opacity="0.3"/>
        <circle cx="388" cy="78" r="5" fill="#7c8aff"/>
        <line x1="388" y1="78" x2="402" y2="70" stroke="#7c8aff" stroke-width="1.5" marker-end="url(#arrowBlue)"/>

        <line x1="140" y1="140" x2="178" y2="118" stroke="#7c8aff" stroke-width="1" stroke-dasharray="3,2" opacity="0.3"/>
        <circle cx="448" cy="118" r="5" fill="#7c8aff"/>
        <line x1="448" y1="118" x2="460" y2="112" stroke="#7c8aff" stroke-width="1.5" marker-end="url(#arrowBlue)"/>

        <line x1="100" y1="180" x2="138" y2="158" stroke="#7c8aff" stroke-width="1" stroke-dasharray="3,2" opacity="0.3"/>
        <circle cx="408" cy="158" r="5" fill="#7c8aff"/>
        <line x1="408" y1="158" x2="422" y2="150" stroke="#7c8aff" stroke-width="1.5" marker-end="url(#arrowBlue)"/>

        <line x1="180" y1="110" x2="218" y2="88" stroke="#7c8aff" stroke-width="1" stroke-dasharray="3,2" opacity="0.3"/>
        <circle cx="498" cy="88" r="5" fill="#7c8aff"/>

        <line x1="60" y1="160" x2="98" y2="138" stroke="#7c8aff" stroke-width="1" stroke-dasharray="3,2" opacity="0.3"/>
        <circle cx="368" cy="138" r="5" fill="#7c8aff"/>
        <line x1="368" y1="138" x2="380" y2="132" stroke="#7c8aff" stroke-width="1.5" marker-end="url(#arrowBlue)"/>

        <text x="380" y="210" font-size="9" fill="#f0ad4e">↕ Noise causes slight deviation</text>
      </svg>
    </div>
    <div class="code-block">
      <div class="label">Pseudocode — Predict step</div>
      <pre><span class="kw">FOR</span> each particle <span class="vr">i</span> <span class="kw">IN</span> 1 .. N:
    <span class="vr">new_particle[i]</span> ← <span class="fn">MOVE</span>(<span class="vr">particle[i]</span>, steering, distance)
        <span class="cm">// apply bicycle model + add motion noise</span>
<span class="vr">particles</span> ← <span class="vr">new_particles</span>                <span class="cm">// calls your Q4 move()</span></pre>
    </div>
    <div class="keys">
      <div class="key-item">
        <div class="key-icon green">✓</div>
        <div class="key-text"><strong>Q4 is exactly this move()</strong>. Bicycle model + noise → each particle lands at a slightly different spot.</div>
      </div>
    </div>
  </div>
</div>

<!-- ========== STEP 3: Update (Sense + Weight) ========== -->
<div class="card hidden" id="step-3">
  <div class="card-header">
    <span class="step-badge">Step 3</span>
    <h2>Update: Use sense() to compute weights</h2>
    <span class="q-tag">← Q5</span>
  </div>
  <div class="card-body">
    <p class="desc">
      The robot's sensor measured the <strong>bearing angle</strong> to each landmark. Now, for every particle, we pretend it is the true position and use <strong>sense()</strong> to predict what the sensor would see. The closer the prediction is to the actual measurement, the <strong>higher the particle's weight</strong>.
    </p>
    <div class="diagram">
      <svg width="520" height="280" viewBox="0 0 520 280">
        <circle cx="60" cy="40" r="5" fill="#f0ad4e"/><text x="68" y="44" font-size="9" fill="#f0ad4e">Landmark</text>
        <circle cx="460" cy="40" r="5" fill="#f0ad4e"/>
        <circle cx="60" cy="240" r="5" fill="#f0ad4e"/>
        <circle cx="460" cy="240" r="5" fill="#f0ad4e"/>

        <line x1="300" y1="150" x2="60" y2="40" stroke="#50c878" stroke-width="1.5" stroke-dasharray="5,3" opacity="0.6"/>
        <line x1="300" y1="150" x2="460" y2="40" stroke="#50c878" stroke-width="1.5" stroke-dasharray="5,3" opacity="0.6"/>
        <line x1="300" y1="150" x2="60" y2="240" stroke="#50c878" stroke-width="1.5" stroke-dasharray="5,3" opacity="0.6"/>
        <line x1="300" y1="150" x2="460" y2="240" stroke="#50c878" stroke-width="1.5" stroke-dasharray="5,3" opacity="0.6"/>
        <circle cx="300" cy="150" r="8" fill="#50c878" opacity="0.8"/>
        <text x="312" y="148" font-size="9" fill="#50c878">True position</text>

        <circle cx="280" cy="140" r="6" fill="#7c8aff"/>
        <line x1="280" y1="140" x2="60" y2="40" stroke="#7c8aff" stroke-width="0.8" opacity="0.4"/>
        <line x1="280" y1="140" x2="460" y2="40" stroke="#7c8aff" stroke-width="0.8" opacity="0.4"/>
        <rect x="236" y="105" width="62" height="18" rx="4" fill="#1a3a2a" stroke="#50c878" stroke-width="1"/>
        <text x="267" y="118" font-size="9" fill="#50c878" text-anchor="middle">Weight: HIGH</text>

        <circle cx="120" cy="180" r="6" fill="#7c8aff" opacity="0.6"/>
        <line x1="120" y1="180" x2="60" y2="40" stroke="#7c8aff" stroke-width="0.8" opacity="0.25"/>
        <line x1="120" y1="180" x2="460" y2="40" stroke="#7c8aff" stroke-width="0.8" opacity="0.25"/>
        <rect x="76" y="195" width="62" height="18" rx="4" fill="#3a1a1a" stroke="#e53e3e" stroke-width="1"/>
        <text x="107" y="208" font-size="9" fill="#e53e3e" text-anchor="middle">Weight: LOW</text>

        <circle cx="420" cy="190" r="6" fill="#7c8aff" opacity="0.4"/>
        <rect x="386" y="200" width="62" height="18" rx="4" fill="#3a1a1a" stroke="#e53e3e" stroke-width="1"/>
        <text x="417" y="213" font-size="9" fill="#e53e3e" text-anchor="middle">Weight: LOW</text>

        <text x="260" y="268" font-size="9" fill="#4a5568" text-anchor="middle">Green dashed = actual measurement; Blue solid = particle prediction. Closer match → higher weight.</text>
      </svg>
    </div>
    <div class="code-block">
      <div class="label">Pseudocode — Update step</div>
      <pre><span class="kw">FOR</span> each particle <span class="vr">i</span> <span class="kw">IN</span> 1 .. N:
    <span class="vr">predicted</span> ← <span class="fn">SENSE</span>(<span class="vr">particle[i]</span>, add_noise = <span class="st">false</span>)
        <span class="cm">// use atan2 to get bearing to each landmark</span>
    <span class="vr">weight[i]</span>  ← <span class="fn">COMPARE</span>(<span class="vr">predicted</span>, <span class="vr">actual_measurement</span>)
        <span class="cm">// closer prediction → higher weight  (calls your Q5 sense())</span></pre>
    </div>
    <div class="keys">
      <div class="key-item">
        <div class="key-icon blue">!</div>
        <div class="key-text"><strong>Q5 is exactly this sense()</strong>. It uses <strong>atan2</strong> to calculate the bearing to each landmark. When <code>add_noise = false</code> it returns a clean prediction for comparison; when <code>add_noise = true</code> it includes sensor noise.</div>
      </div>
    </div>
  </div>
</div>

<!-- ========== STEP 4: Resample ========== -->
<div class="card hidden" id="step-4">
  <div class="card-header">
    <span class="step-badge">Step 4</span>
    <h2>Resample: Keep the high-weight particles</h2>
  </div>
  <div class="card-body">
    <p class="desc">
      Resample the particles based on their weights. <strong>High-weight particles get duplicated</strong>, low-weight particles get dropped. This pulls the particle cloud toward the true position.
    </p>
    <div class="diagram">
      <svg width="520" height="230" viewBox="0 0 520 230">
        <rect x="10" y="15" width="220" height="200" rx="8" fill="#1a1d2e" stroke="#2e3348" stroke-width="1"/>
        <text x="25" y="37" font-size="10" fill="#4a5568">Before resample</text>

        <circle cx="60" cy="70" r="7" fill="#7c8aff" opacity="0.9"/>
        <text x="72" y="75" font-size="9" fill="#50c878">weight 0.8</text>

        <circle cx="60" cy="110" r="5" fill="#7c8aff" opacity="0.5"/>
        <text x="72" y="115" font-size="9" fill="#e53e3e">weight 0.1</text>

        <circle cx="60" cy="145" r="6" fill="#7c8aff" opacity="0.7"/>
        <text x="72" y="150" font-size="9" fill="#f0ad4e">weight 0.5</text>

        <circle cx="60" cy="180" r="4" fill="#7c8aff" opacity="0.35"/>
        <text x="72" y="185" font-size="9" fill="#e53e3e">weight 0.05</text>

        <text x="255" y="120" font-size="22" fill="#3b4cc0" text-anchor="middle">→</text>
        <text x="255" y="138" font-size="9" fill="#4a5568" text-anchor="middle">resample</text>

        <rect x="290" y="15" width="220" height="200" rx="8" fill="#1a1d2e" stroke="#2e3348" stroke-width="1"/>
        <text x="305" y="37" font-size="10" fill="#4a5568">After resample</text>

        <circle cx="340" cy="65" r="7" fill="#7c8aff"/><text x="355" y="70" font-size="9" fill="#7c8aff">← copied from 0.8</text>
        <circle cx="340" cy="95" r="7" fill="#7c8aff"/><text x="355" y="100" font-size="9" fill="#7c8aff">← copied from 0.8</text>
        <circle cx="340" cy="125" r="7" fill="#7c8aff"/><text x="355" y="130" font-size="9" fill="#7c8aff">← copied from 0.8</text>
        <circle cx="340" cy="158" r="6" fill="#7c8aff" opacity="0.7"/><text x="355" y="163" font-size="9" fill="#f0ad4e">← copied from 0.5</text>
        <text x="340" y="195" font-size="9" fill="#4a5568">weights 0.1 &amp; 0.05 dropped</text>
      </svg>
    </div>
    <div class="code-block">
      <div class="label">Pseudocode — Resample (already provided, no need to implement)</div>
      <pre><span class="vr">new_particles</span> ← empty list
<span class="vr">beta</span> ← 0
<span class="kw">FOR</span> each particle <span class="vr">i</span> <span class="kw">IN</span> 1 .. N:
    <span class="vr">beta</span> ← <span class="vr">beta</span> + <span class="fn">random</span>() × 2 × max(weights)
    <span class="kw">WHILE</span> <span class="vr">beta</span> > <span class="vr">weight[current]</span>:
        <span class="vr">beta</span> ← <span class="vr">beta</span> − <span class="vr">weight[current]</span>
        <span class="vr">current</span> ← next particle           <span class="cm">// spin the wheel</span>
    <span class="fn">ADD</span> <span class="vr">particle[current]</span> <span class="kw">TO</span> <span class="vr">new_particles</span>  <span class="cm">// high weight → picked more often</span></pre>
    </div>
    <div class="keys">
      <div class="key-item">
        <div class="key-icon orange">★</div>
        <div class="key-text">This step is <strong>already implemented</strong> — you don't need to write it. It uses the "wheel resampling" algorithm: the higher the weight, the more often a particle gets selected.</div>
      </div>
    </div>
  </div>
</div>

<!-- ========== STEP 5: Repeat ========== -->
<div class="card hidden" id="step-5">
  <div class="card-header">
    <span class="step-badge">Step 5</span>
    <h2>Repeat: Particles converge to the true position</h2>
    <span class="q-tag">← Q6 overall</span>
  </div>
  <div class="card-body">
    <p class="desc">
      The three steps above (predict → update → resample) run inside a <strong>loop</strong>. With each iteration the particles cluster tighter and tighter, eventually converging on the robot's real position.
    </p>
    <div class="diagram">
      <svg width="520" height="250" viewBox="0 0 520 250">
        <rect x="10" y="30" width="150" height="170" rx="8" fill="#1a1d2e" stroke="#2e3348" stroke-width="1"/>
        <text x="85" y="52" font-size="10" fill="#94a3b8" text-anchor="middle">After round 1</text>
        <circle cx="50" cy="80" r="4" fill="#7c8aff" opacity="0.5"/>
        <circle cx="120" cy="100" r="4" fill="#7c8aff" opacity="0.5"/>
        <circle cx="70" cy="140" r="4" fill="#7c8aff" opacity="0.5"/>
        <circle cx="130" cy="160" r="4" fill="#7c8aff" opacity="0.5"/>
        <circle cx="40" cy="170" r="4" fill="#7c8aff" opacity="0.5"/>
        <circle cx="100" cy="75" r="4" fill="#7c8aff" opacity="0.5"/>
        <circle cx="60" cy="120" r="4" fill="#7c8aff" opacity="0.5"/>
        <circle cx="140" cy="130" r="4" fill="#7c8aff" opacity="0.5"/>
        <circle cx="85" cy="120" r="6" fill="none" stroke="#50c878" stroke-width="1.5" stroke-dasharray="3,2"/>

        <text x="175" y="120" font-size="18" fill="#3b4cc0">→</text>

        <rect x="185" y="30" width="150" height="170" rx="8" fill="#1a1d2e" stroke="#2e3348" stroke-width="1"/>
        <text x="260" y="52" font-size="10" fill="#94a3b8" text-anchor="middle">After round 4</text>
        <circle cx="240" cy="100" r="4" fill="#7c8aff" opacity="0.7"/>
        <circle cx="270" cy="115" r="4" fill="#7c8aff" opacity="0.7"/>
        <circle cx="250" cy="125" r="4" fill="#7c8aff" opacity="0.7"/>
        <circle cx="280" cy="105" r="4" fill="#7c8aff" opacity="0.7"/>
        <circle cx="255" cy="95" r="4" fill="#7c8aff" opacity="0.7"/>
        <circle cx="230" cy="130" r="4" fill="#7c8aff" opacity="0.6"/>
        <circle cx="275" cy="130" r="4" fill="#7c8aff" opacity="0.6"/>
        <circle cx="260" cy="90" r="4" fill="#7c8aff" opacity="0.6"/>
        <circle cx="260" cy="115" r="6" fill="none" stroke="#50c878" stroke-width="1.5" stroke-dasharray="3,2"/>

        <text x="350" y="120" font-size="18" fill="#3b4cc0">→</text>

        <rect x="365" y="30" width="145" height="170" rx="8" fill="#1a1d2e" stroke="#2e3348" stroke-width="1.5"/>
        <text x="437" y="52" font-size="10" fill="#50c878" text-anchor="middle">After round 8 ✓</text>
        <circle cx="430" cy="112" r="4" fill="#7c8aff"/>
        <circle cx="440" cy="118" r="4" fill="#7c8aff"/>
        <circle cx="435" cy="108" r="4" fill="#7c8aff"/>
        <circle cx="428" cy="120" r="4" fill="#7c8aff"/>
        <circle cx="442" cy="110" r="4" fill="#7c8aff"/>
        <circle cx="433" cy="122" r="4" fill="#7c8aff"/>
        <circle cx="438" cy="105" r="4" fill="#7c8aff"/>
        <circle cx="425" cy="115" r="4" fill="#7c8aff"/>
        <circle cx="437" cy="115" r="7" fill="none" stroke="#50c878" stroke-width="2"/>

        <text x="260" y="230" font-size="10" fill="#64748b" text-anchor="middle">Particles cluster tighter each round → estimated position becomes more accurate</text>
      </svg>
    </div>
    <div class="code-block">
      <div class="label">Pseudocode — Full particle filter loop</div>
      <pre><span class="kw">FOR</span> each time step <span class="vr">t</span>:

    <span class="cm">// Step 1: Predict (your Q4 move)</span>
    <span class="kw">FOR</span> each particle <span class="vr">i</span>:
        <span class="vr">particle[i]</span> ← <span class="fn">MOVE</span>(<span class="vr">particle[i]</span>, motion[t])

    <span class="cm">// Step 2: Update weights (your Q5 sense)</span>
    <span class="kw">FOR</span> each particle <span class="vr">i</span>:
        <span class="vr">weight[i]</span> ← <span class="fn">COMPARE</span>(<span class="fn">SENSE</span>(<span class="vr">particle[i]</span>), measurement[t])

    <span class="cm">// Step 3: Resample (already provided)</span>
    <span class="vr">particles</span> ← <span class="fn">RESAMPLE</span>(<span class="vr">particles</span>, <span class="vr">weights</span>)</pre>
    </div>
    <div class="keys">
      <div class="key-item">
        <div class="key-icon green">✓</div>
        <div class="key-text">For Q6 you only need to supply <strong>move()</strong> and <strong>sense()</strong>. The grader wires the full loop together. The test requires the position error to be within 15 in at least 12 out of 20 tries.</div>
      </div>
    </div>
  </div>
</div>

<div class="nav" id="nav"></div>

<script>
const steps = [
  { id: 'step-0', label: 'Overview' },
  { id: 'step-1', label: '① Init' },
  { id: 'step-2', label: '② Predict (Q4)' },
  { id: 'step-3', label: '③ Update (Q5)' },
  { id: 'step-4', label: '④ Resample' },
  { id: 'step-5', label: '⑤ Loop (Q6)' },
];

let current = 0;

// Build tabs
const tabsEl = document.getElementById('tabs');
steps.forEach((s, i) => {
  const btn = document.createElement('div');
  btn.className = 'tab' + (i === 0 ? ' active' : '');
  btn.textContent = s.label;
  btn.onclick = () => goTo(i);
  tabsEl.appendChild(btn);
});

// Build nav
const navEl = document.getElementById('nav');
const prevBtn = document.createElement('button');
prevBtn.className = 'nav-btn'; prevBtn.id = 'prevBtn';
prevBtn.textContent = '← Previous'; prevBtn.onclick = () => goTo(current - 1);
navEl.appendChild(prevBtn);
const nextBtn = document.createElement('button');
nextBtn.className = 'nav-btn'; nextBtn.id = 'nextBtn';
nextBtn.textContent = 'Next →'; nextBtn.onclick = () => goTo(current + 1);
navEl.appendChild(nextBtn);

function goTo(i) {
  if (i < 0 || i >= steps.length) return;
  document.getElementById(steps[current].id).classList.add('hidden');
  current = i;
  document.getElementById(steps[current].id).classList.remove('hidden');
  // Update tabs
  document.querySelectorAll('.tab').forEach((t, idx) => {
    t.classList.toggle('active', idx === current);
  });
  // Update nav
  document.getElementById('prevBtn').disabled = (current === 0);
  document.getElementById('nextBtn').disabled = (current === steps.length - 1);
}

goTo(0);
</script>
</body>
</html>
